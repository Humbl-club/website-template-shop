{% comment %}
  Renders a product card

  Accepts:
  - card_product: {Object} Product Liquid object (optional)
  - media_aspect_ratio: {String} Size of the product image. Values are "square", "portrait", "landscape" or "fit to image". Default is "square"
  - show_secondary_image: {Boolean} Show a secondary image on hover. Default: false
  - show_price: {Boolean} Show the product vendor. Default: true
  - price_position: Bottom (default) or top
  - show_sale_badges: Shows a "Sale" badge if a product price is discounted. Default: true
  - show_vendor: {Boolean} Show the product vendor (brand). Default: false
  - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)
  - show_quick_add: {Boolean} Show the quick add button
  - section_id: {String} The ID of the section that contains this card

  Usage:
  {% render 'card-product', show_vendor: section.settings.show_vendor %}
{% endcomment %}

{% assign show_product_rating = false %}
{% if show_rating %}
{% assign show_product_rating = true %}
{% endif %}

{% assign card_colors_count_show = false %}
{% assign card_colors_swatches_show = false %}

{% if show_swatches %}
{% assign card_colors_swatches_show = true %}
{% endif %}

{% assign swatch_shape = settings.card_swatch_shape %}

{% assign card_variant_thumbnails_show = false %}
{% if show_variant_thumbnails %}
{% assign card_variant_thumbnails_show = true %} 
{% endif %}

{% assign card_sizes_show = false %}

{% assign color_names = 'Barva,Barvy,Boja,Color,Colors,Colour,Colours,Couleur,Couleurs,Cor,Cores,Colore,Colores,Culoare,Culori,Farbe,Farba,Farge,Farve,Färg,Färger,Warna,Kleur,Kleuren,Kolor,Zabarwienie,Szín,Litur,Renk,Spalva,Боја,колір,Цвет,Цвят,Χρώμα,Väri,色,색상' | split: ',' %}

{% assign size_names = 'Size,Taille,Tamaño,Misurare,Tamanho,Størrelse' | split: ',' %}

{% assign media_size = 800 %}

{% assign static_images = true %}
{% if show_swiping_images or show_secondary_image %}
{% assign static_images = false %}
{% endif %}

{% if image_resolution == 'high' %}
{% assign media_size = 1280 %}  
{% endif %}

{% assign pagination_style = settings.media_pagination_style %}

{% if settings.card_media_pagination_style == 'track' %}
{% assign pagination_style = 'track' %}
{% endif %}

<div class="card card-product card-ratio-{{ media_aspect_ratio }}">
<div class="card-media">
<a href="{{ card_product.url }}" title="{{ card_product.title }}">
<div class="card-product--badges pc-badges-{{ settings.card_badge_position }}{% if settings.badge_corner_radius > 16 %} pc-badges-rounded-radius{% endif %}">  
{% for tag in card_product.tags %}  
{% if tag contains 'Badge:' %}<span>{{ tag | remove: 'Badge: '}}</span>
{% endif %}
{% endfor %}
{% if show_sale_badges %}
  {% if card_product.compare_at_price %}<span>{{ 'products.product.on_sale' | t }}</span>{% endif %}  
{% endif %}
</div>

{% assign images = card_product.media %}
  
{% if show_swiping_images and images.size > 1 %}
    <div class="card-product--image-swipe-container pagination-color-scheme-{{ pagination_color_scheme }} card-pagination-arrow-style-{{ settings.card_media_pagination_arrow_style }}">
      <div class="product-card--media-pagination align-{{ settings.card_text_alignment }} pagination-style-{{ pagination_style }} pagination-position--{{ settings.card_media_pagination_position }}{% if settings.card_text_padding == 0 %} pagination-has-zero-hoz-padding{% endif %}{% if show_quick_add %} product-card--media-pagination-with-quick-add{% endif %}">
        {% for image in images limit: 4 %}
          <span class="product-card--pagination-bullet blt-data-{{ forloop.index }}{% if forloop.first %} active{% endif %}" data-value="{{ forloop.index }}"></span>
        {% endfor %}
      </div>

      <button class="product-card-pagination-arrow pcpa-left" aria-label="{{ 'accessibility.left' | t }}">{% render 'icon-caret' %}</button>
      <button class="product-card-pagination-arrow pcpa-right" aria-label="{{ 'accessibility.right' | t }}">{% render 'icon-caret' %}</button>
      
      <div class="card-product--image-swipe-track">
        {% for image in images limit: 4 %}
          <div class="card-product--image card-product--image-slide" data-value="{{ forloop.index }}">
            <div class="card-product--image-wrapper">
              {% if lazy_load %}
                {{ image | image_url: width: media_size | image_tag: loading: 'lazy' }}
              {% else %}
                {{ image | image_url: width: media_size | image_tag }}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
{% endif %}

{% if show_secondary_image and images.size > 1 %}
<div class="card-product-image-outer">
  <div class="card-product--image">
  <div class="card-product--image-wrapper">
    <div class="product-card-default-image product-card-fade-out-image">
    {% if lazy_load %}
    {{ card_product.featured_media | image_url: width: media_size | image_tag: loading: 'lazy' }}
    {% else %}
    {{ card_product.featured_media | image_url: width: media_size | image_tag }}
    {% endif %}
    </div>
    <div class="product-card-reveal-image">
    {% for image in images %}
      {% if image != card_product.featured_media %}
        {{ image | image_url: width: media_size | image_tag: loading: 'lazy' }}
        {% break %}
      {% endif %}
    {% endfor %}
    </div>
  </div>
  </div>
</div>
{% endif %}
  
{% if images.size < 2 or static_images %}
<div class="card-product-image-outer">
  <div class="card-product--image">
  <div class="card-product--image-wrapper card-product--single-image-wrapper">
  {% if card_product.featured_media %}
  {% if lazy_load %}
  {{ card_product.featured_media | image_url: width: media_size | image_tag: loading: 'lazy' }}
  {% else %}
  {{ card_product.featured_media | image_url: width: media_size | image_tag }}
  {% endif %}
  {% endif %}

  {% comment %} Placeholder images for theme editor onboarding {% endcomment %}
  {% if placeholder %}
  {% render 'media-placeholder-product', sequence_number: sequence_number %}
  {% endif %}
    
  </div>
  </div>
</div>
{% endif %}

</a>
{%- if show_quick_add and placeholder == true -%}
  <div class="product-card-quick-add{% if settings.quick_add_desktop_rollover %} quick-add-desktop-hover{% else %} quick-add-desktop-static{% endif %} align-{{ settings.card_text_alignment }} quick-add-button-mobile-{{ settings.card_quick_add_style_mobile }} quick-add-button-desktop-{{ settings.card_quick_add_style_desktop }}">
  <div class="quick-add no-js-hidden">
    <span class="button quick-add-f-button">
      <div class="qa-label">{{ 'products.product.add_to_cart' | t }}</div>
      {%- if settings.card_quick_add_style_mobile == 'icon' or settings.card_quick_add_style_desktop == 'icon' -%}
      <div class="qa-label-icon">{% render 'icon-quick-add' %}</div>
      {%- endif -%}    
    </span>
  </div>
  </div>
{%- endif -%}
{%- if show_quick_add and placeholder != true -%}
  <div class="product-card-quick-add{% if settings.quick_add_desktop_rollover %} quick-add-desktop-hover{% else %} quick-add-desktop-static{% endif %} align-{{ settings.card_text_alignment }} quick-add-button-mobile-{{ settings.card_quick_add_style_mobile }} quick-add-button-desktop-{{ settings.card_quick_add_style_desktop }}">
  <div class="quick-add no-js-hidden">
    {%- liquid
      assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id
      assign qty_rules = false
      if card_product.selected_or_first_available_variant.quantity_rule.min > 1 or card_product.selected_or_first_available_variant.quantity_rule.max != null or card_product.selected_or_first_available_variant.quantity_rule.increment > 1
        assign qty_rules = true
      endif
    -%}
    {%- if card_product.variants.size > 1 or qty_rules -%}
      <modal-opener data-modal="#QuickAdd-{{ card_product.id }}">
        <button
          id="{{ product_form_id }}-submit"
          type="submit"
          name="add"
          class="quick-add__submit button"
          aria-haspopup="dialog"
          aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
          data-product-url="{{ card_product.url }}"
        >
          <span class="qa-label">{{ 'products.product.choose_options' | t }}</span>
          {%- if settings.card_quick_add_style_mobile == 'icon' or settings.card_quick_add_style_desktop == 'icon' -%}
          <div class="qa-label-icon">{% render 'icon-quick-add' %}</div>
          {%- endif -%}
          <div class="loading-overlay__spinner hidden">
            <svg
              aria-hidden="true"
              focusable="false"
              class="spinner"
              viewBox="0 0 66 66"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
            </svg>
          </div>
        </button>
      </modal-opener>

      <quick-add-modal id="QuickAdd-{{ card_product.id }}" class="quick-add-modal{% if settings.card_quick_card_style_mobile == 'minimal' %} quick-add-modal-mobile-minimal{% endif %} modal-image-ratio-{{ media_aspect_ratio }}">
        <div
          role="dialog"
          aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
          aria-modal="true"
          class="quick-add-modal__content global-settings-popup"
          tabindex="-1"
        >
          {% assign request_parent = quick_add_modal %}
          <div class="visually-hidden">{{ request_parent }}</div>
          <div class="quick-add-modal-header">
            <button
              id="ModalClose-{{ card_product.id }}"
              type="button"
              class="quick-add-modal__toggle"
              aria-label="{{ 'accessibility.close' | t }}"
            >
              {% render 'icon-close' %}
            </button>
          </div>
          <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
        </div>
      </quick-add-modal>
    {%- else -%}
      <product-form data-section-id="{{ section.id }}">
        {%- form 'product',
          card_product,
          id: product_form_id,
          class: 'form',
          novalidate: 'novalidate',
          data-type: 'add-to-cart-form'
        -%}
          <input
            type="hidden"
            name="id"
            value="{{ card_product.selected_or_first_available_variant.id }}"
            {% if card_product.selected_or_first_available_variant.available == false %}
              disabled
            {% endif %}
          >
          <button
            id="{{ product_form_id }}-submit"
            type="submit"
            name="add"
            class="quick-add__submit button"
            aria-haspopup="dialog"
            aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
            aria-live="polite"
            data-sold-out-message="true"
            {% if card_product.selected_or_first_available_variant.available == false %}
              disabled
            {% endif %}
          >
            <span class="qa-label">
              {%- if card_product.selected_or_first_available_variant.available -%}
                {{ 'products.product.add_to_cart' | t }}
              {%- else -%}
                {{ 'products.product.sold_out' | t }}
              {%- endif -%}
            </span>
            <span class="sold-out-message hidden">
              {{ 'products.product.sold_out' | t }}
            </span>
            {%- if settings.card_quick_add_style_mobile == 'icon' or settings.card_quick_add_style_desktop == 'icon' -%}
            <div class="qa-label-icon">{% render 'icon-quick-add' %}</div>
            {%- endif -%}
            <div class="loading-overlay__spinner hidden">
              <svg
                aria-hidden="true"
                focusable="false"
                class="spinner"
                viewBox="0 0 66 66"
                xmlns="http://www.w3.org/2000/svg"
              >
                <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
              </svg>
            </div>
          </button>
        {%- endform -%}
      </product-form>
    {%- endif -%}
  </div>
  </div>

{%- endif -%}
</div>
<a href="{{ card_product.url }}" class="card-product--text-section-link">
<div class="card-product--text-section{% if settings.card_text_border %} card-product--text-section-border{% endif %}{% if price_position == 'right' %} card-product--text-section--flex{% endif %}">

{% comment %}OPTIONAL - SHOW VARIANT THUMBNAILS {% endcomment %}
{% if card_variant_thumbnails_show %}
  <div class="card-product--variant-thumbnails-list align-{{ settings.card_text_alignment }}">
  {% for option in card_product.options_with_values %}
  {% if color_names contains option.name %}
    {% for value in option.values %}
      {% assign matched_variant = nil %}
      {% assign available = false %}
  
      {% for variant in card_product.variants %}
        {% if variant.options contains value %}
          {% assign matched_variant = variant %}
          {% if variant.available %}
            {% assign available = true %}
          {% endif %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% if matched_variant and matched_variant.featured_media %}
      <div class="card-product--variant-thumbnail ratio-{{ media_aspect_ratio }}{% unless available %} card-product--variant-unavailable{% endunless %}">
          {{ matched_variant.featured_media | image_url: width: 80 | image_tag: loading: 'lazy' }}
      </div>
      {% endif %}
    {% endfor %}
  {% endif %}
  {% endfor %}
  </div>
{% endif %}
  
<div class="card-product--title">
{% if show_vendor %}
<span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
{% if show_vendor_inline %}
<h3 class="card-product-title-h3 card-title-font-family-{{ settings.card_title_font }}">{% if placeholder %}<span class="vendor--style-{{ settings.card_vendor_text_style }}">{{ 'products.product.vendor' | t }}</span>{% endif %}<span class="vendor--style-{{ settings.card_vendor_text_style }}">{{ card_product.vendor }}</span> {{ card_product.title | escape }}{% if placeholder %}{{ 'onboarding.product_title' | t }}{% endif %}</h3>
{% else %}
<div class="card-product-vendor vendor--style-{{ settings.card_vendor_text_style }}">{{ card_product.vendor }}{% if placeholder %}{{ 'products.product.vendor' | t }}{% endif %}</div>
<h3 class="card-product-title-h3 card-title-font-family-{{ settings.card_title_font }}">{{ card_product.title | escape }}{% if placeholder %}{{ 'onboarding.product_title' | t }}{% endif %}</h3>
{% endif %}
{% else %}
<h3 class="card-product-title-h3 card-title-font-family-{{ settings.card_title_font }}">
  {{ card_product.title | escape }}{% if placeholder %}{{ 'onboarding.product_title' | t }}{% endif %}
</h3>
{% endif %}
{% if settings.card_show_product_type %}
<span class="card-product-type-label">{{ card_product.type }}</span>
{% endif %}

</div>
  
<div class="card-product--info">
{% if show_price %}
{% unless hide_price %}
<div class="card-product--price{% if settings.card_price_sale_highlight %} card-price-sale-highlighted{% endif %}{% if settings.card_text_alignment == 'center' %} card-price-center{% endif %}">{% render 'price', product: card_product, price_class: '' %}</div>
{% endunless %}
{% endif %}

{% if show_product_rating and card_product.metafields.reviews.rating.value != blank %}
  
{% liquid
  assign rating_decimal = 0
  assign decimal = card_product.metafields.reviews.rating.value.rating | modulo: 1
  if decimal >= 0.3 and decimal <= 0.7
    assign rating_decimal = 0.5
  elsif decimal > 0.7
    assign rating_decimal = 1
  endif
%}
  
<div
  class="rating"
  role="img"
  aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: card_product.metafields.reviews.rating.value, rating_max: card_product.metafields.reviews.rating.value.scale_max }}"
>
  <span
    aria-hidden="true"
    class="rating-star"
    style="--rating: {{ card_product.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ card_product.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};"
  ></span>
</div>
<p class="rating-text caption">
  <span aria-hidden="true">
    {{- card_product.metafields.reviews.rating.value }} /
    {{ card_product.metafields.reviews.rating.value.scale_max -}}
  </span>
</p>
<p class="rating-count caption">
  <span aria-hidden="true">{{ card_product.metafields.reviews.rating_count }} {{ 'products.product.reviews' | t }}</span>
  <span class="visually-hidden">
    {{- card_product.metafields.reviews.rating_count }}
    {{ 'accessibility.total_reviews' | t -}}
  </span>
</p>  
{% endif %}

  
{% if card_product.available == false %}
<div class="card-product-badge badge-sold-out">{{- 'products.product.sold_out' | t -}}</div>
{% endif %}

{% comment %}COLOR SWATCHES{% endcomment %}
{% if card_colors_count_show %}
{% assign color_count = 0 %}
  
{% for option in card_product.options_with_values %}
  {% if color_names contains option.name %}
  {% for value in option.values %}
  {% assign color_count = color_count | plus: 1 %}
  {% endfor %}
  {% endif %}
{% endfor %}

{% if color_count > 1 %}
<div class="card-product--color-count align-{{ settings.card_text_alignment }}">
  {{ color_count }} {{ 'products.product.colors' | t }}
</div>
{% endif %}
{% endif %}
  
{% if card_colors_swatches_show %}

{% for option in card_product.options_with_values %}
  {% if color_names contains option.name %}
  {% for value in option.values %}
  {% assign color_count = color_count | plus: 1 %}
  {% endfor %}
  {% endif %}
{% endfor %}

{% if color_count > 1 %}

<div class="card-product--color-swatches swatches-align-{{ settings.card_text_alignment }}">
  {% for option in card_product.options_with_values %}
    {% if color_names contains option.name %}
    {% for value in option.values limit: 5 %}
    <div class="card-product-variant-swatch card-swatch-shape-{{ swatch_shape }} card-swatch-color-{{ value.name | handleize }}">
        {% render 'swatch', swatch: value.swatch %}
    </div>
    {% endfor %}
    {% if color_count > 5 %}<div class="card-swatch-shape-{{ swatch_shape }} card-product-variant-swatches--more">{% render 'icon-plus' %}</div>{% endif %}
    {% endif %}
  {% endfor %}
</div>
{% endif %}
  
{% endif %}

{% comment %}OPTIONAL - SHOW AVAILABLE SIZE VARIANTS {% endcomment %}
{% if card_sizes_show %}
<div class="card-product--size-options align-{{ settings.card_text_alignment }}">
  {% for option in card_product.options_with_values %}
    {% assign available = false %}
    
    {% if size_names contains option.name %} 
    {% for value in option.values %}
    {% if value.available %}{% assign available = true %}{% endif %}
    <div class="text-small card-product--variant-size{% if available == false %} card-product--size-unavailable{% endif %} size-name-{{ value.name | handleize }}">{{ value.name }}</div>
    {% endfor %}
    {% endif %}
  {% endfor %}
</div>
{% endif %}
  
{% if card_product.metafields.custom.excerpt != blank %}
<div class="card-product-excerpt">{{ card_product.metafields.custom.excerpt | metafield_tag }}</div>
{% endif %}
</div>
</div>
</a>  
</div>